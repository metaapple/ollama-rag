<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ollama FastAPI Tester</title>

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    /* 결과 출력 박스: 콘솔 느낌 + 줄바꿈/공백 유지 */
    #result {
      white-space: pre-wrap;
      overflow: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95rem;
      line-height: 1.45;
      min-height: 380px;
      max-height: 520px;
      background: #fff8c5; /* 너무 쨍한 노랑 대신 부드러운 톤 */
      border: 1px solid rgba(0,0,0,.1);
      border-radius: 12px;
      padding: 14px 16px;
    }

    /* 긴 문자열도 보기 좋게 */
    #result {
      word-break: break-word;
    }
  </style>
</head>

<body class="bg-light">
  <div class="container py-4 py-lg-5">

    <!-- Header -->
    <div class="d-flex align-items-start align-items-md-center justify-content-between flex-column flex-md-row gap-3 mb-4">
      <div>
        <h1 class="h4 mb-1">Ollama + FastAPI 테스트</h1>
        <div class="text-secondary small">
          링크/입력으로 API 호출 후 결과를 아래 콘솔 형태로 출력합니다.
        </div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary btn-sm" href="/health">Health</a>
        <a class="btn btn-outline-secondary btn-sm" href="/chat?word=httpport">http 기본 port</a>
        <a class="btn btn-outline-secondary btn-sm" href="/stream?word=한국정보">korea 정보(한글)</a>
        <a class="btn btn-outline-secondary btn-sm" href="/chat?word=bmw">bmw 정보</a>
        <!-- 새로 추가된 ollama-rag2 버튼 -->
        <a href="/ollama-test">
        <button id="ollamaTestBtn" class="btn btn-outline-primary btn-sm">
          ollama-test
        </button>
        </a>
      </div>
    </div>

    <div class="row g-4">
      <!-- Left: Forms -->
      <div class="col-12 col-lg-5">
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-body p-4">

            <div class="mb-3">
              <div class="fw-semibold mb-1">스트리밍 페이지로 이동</div>
              <div class="text-secondary small">GET /stream?word=...</div>
            </div>

            <form method="get" action="/stream" class="mb-4">
              <div class="input-group">
                <span class="input-group-text">word</span>
                <input type="text" class="form-control" name="word" value="2002 worldcup" />
                <button class="btn btn-primary" type="submit">Search</button>
              </div>
              <div class="form-text">
                이 폼은 결과를 아래 박스가 아니라 <code>/stream</code> 페이지에서 확인합니다.
              </div>
            </form>

            <hr class="my-4" />

            <div class="mb-3">
              <div class="fw-semibold mb-1">아래 결과 박스에 출력</div>
              <div class="text-secondary small">GET /chat?word=...</div>
            </div>

            <div class="input-group">
              <span class="input-group-text">word</span>
              <input type="text" id="word" class="form-control" value="2002 월드컵" />
              <button id="under" class="btn btn-success" type="button">
                결과 출력
              </button>
            </div>

            <hr class="my-4" />

            <div class="mb-3">
              <div class="fw-semibold mb-1">채팅 히스토리 불러오기</div>
              <div class="text-secondary small">GET /chat-history/{session_id}</div>
            </div>

            <div class="input-group mb-3">
              <span class="input-group-text">session_id</span>
              <input type="text" id="sessionId" class="form-control" value="default" />
              <button id="loadHistory" class="btn btn-info" type="button">
                히스토리 불러오기
              </button>
            </div>

            <div class="d-flex align-items-center justify-content-between mt-3">
              <div class="text-secondary small">
                마크다운이 자동으로 파싱되어 표시됩니다.
              </div>
              <button id="clear" class="btn btn-link btn-sm text-decoration-none" type="button">
                Clear
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Right: Result -->
      <div class="col-12 col-lg-7">
        <div class="card shadow-sm border-0 rounded-4">
          <div class="card-header bg-white border-0 rounded-top-4 px-4 pt-4 pb-2">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="fw-semibold">Result</div>
                <div class="text-secondary small">콘솔 스타일 출력 영역</div>
              </div>
              <span id="status" class="badge text-bg-secondary">idle</span>
            </div>
          </div>

          <div class="card-body px-4 pb-4">
            <div id="result">여기에 결과가 표시됩니다.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* 마크다운 스타일 추가 */
    #result.markdown-content {
      white-space: normal;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    #result.markdown-content h1,
    #result.markdown-content h2,
    #result.markdown-content h3 {
      margin-top: 1em;
      margin-bottom: 0.5em;
      font-weight: 600;
    }
    #result.markdown-content h1 { font-size: 1.5em; }
    #result.markdown-content h2 { font-size: 1.3em; }
    #result.markdown-content h3 { font-size: 1.1em; }
    #result.markdown-content p {
      margin: 0.5em 0;
    }
    #result.markdown-content ul,
    #result.markdown-content ol {
      margin: 0.5em 0;
      padding-left: 1.5em;
    }
    #result.markdown-content li {
      margin: 0.25em 0;
    }
    #result.markdown-content code {
      background: rgba(0,0,0,0.05);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9em;
    }
    #result.markdown-content pre {
      background: rgba(0,0,0,0.05);
      padding: 0.8em;
      border-radius: 6px;
      overflow-x: auto;
      margin: 0.8em 0;
    }
    #result.markdown-content pre code {
      background: none;
      padding: 0;
    }
    #result.markdown-content strong {
      font-weight: 600;
    }
    #result.markdown-content em {
      font-style: italic;
    }
    #result.markdown-content blockquote {
      border-left: 3px solid rgba(0,0,0,0.2);
      padding-left: 1em;
      margin: 0.8em 0;
      color: #666;
    }
  </style>

  <script>
    const resultEl = document.getElementById("result");
    const statusEl = document.getElementById("status");
    const wordEl = document.getElementById("word");

    function setStatus(type, text) {
      statusEl.className = "badge";
      if (type === "loading") statusEl.classList.add("text-bg-warning");
      else if (type === "ok") statusEl.classList.add("text-bg-success");
      else if (type === "error") statusEl.classList.add("text-bg-danger");
      else statusEl.classList.add("text-bg-secondary");
      statusEl.textContent = text;
    }

    document.getElementById("under").addEventListener("click", async function () {
      const word = wordEl.value.trim();
      if (!word) {
        resultEl.textContent = "word 값을 입력하세요.";
        resultEl.classList.remove("markdown-content");
        setStatus("error", "empty");
        return;
      }

      setStatus("loading", "loading");
      resultEl.textContent = "요청 중...";
      resultEl.classList.remove("markdown-content");

      try {
        const response = await axios.get("/chat", { params: { word } });
        const data = response.data;

        // response.data.history가 있는지 확인
        if (data.history && Array.isArray(data.history)) {
          // history 배열에서 assistant 메시지의 마크다운을 파싱
          let markdownContent = "";
          data.history.forEach(msg => {
            if (msg.role === "assistant" && msg.content) {
              markdownContent += msg.content + "\n\n";
            }
          });

          if (markdownContent) {
            // 마크다운을 HTML로 변환
            resultEl.innerHTML = marked.parse(markdownContent);
            resultEl.classList.add("markdown-content");
          } else {
            // history가 있지만 assistant 메시지가 없는 경우
            resultEl.textContent = "히스토리에 표시할 내용이 없습니다.";
            resultEl.classList.remove("markdown-content");
          }
        } else if (typeof data === "string") {
          // 기존 방식: 문자열 데이터를 마크다운으로 파싱 시도
          resultEl.innerHTML = marked.parse(data);
          resultEl.classList.add("markdown-content");
        } else {
          // 그 외의 경우 텍스트로 표시
          resultEl.textContent = JSON.stringify(data, null, 2);
          resultEl.classList.remove("markdown-content");
        }

        setStatus("ok", "ok");
      } catch (err) {
        console.error(err);

        const msg = err.message;

        resultEl.textContent = "에러 발생:\n" + msg;
        resultEl.classList.remove("markdown-content");
        setStatus("error", "error");
      }
    });

    // 히스토리 불러오기 버튼
    document.getElementById("loadHistory").addEventListener("click", async function () {
      const sessionId = document.getElementById("sessionId").value.trim() || "default";

      setStatus("loading", "loading");
      resultEl.textContent = "요청 중...";
      resultEl.classList.remove("markdown-content");

      try {
        const response = await axios.get(`/chat-history/${sessionId}`);
        const history = response.data.history;

        if (history && Array.isArray(history) && history.length > 0) {
          // history 배열에서 assistant 메시지의 마크다운을 파싱
          let markdownContent = "";
          history.forEach(msg => {
            if (msg.role === "assistant" && msg.content) {
              markdownContent += msg.content + "\n\n";
            }
          });

          if (markdownContent) {
            // 마크다운을 HTML로 변환
            resultEl.innerHTML = marked.parse(markdownContent);
            resultEl.classList.add("markdown-content");
            setStatus("ok", "ok");
          } else {
            resultEl.textContent = "히스토리에 표시할 assistant 메시지가 없습니다.";
            resultEl.classList.remove("markdown-content");
            setStatus("ok", "empty");
          }
        } else {
          resultEl.textContent = "히스토리가 비어있습니다.";
          resultEl.classList.remove("markdown-content");
          setStatus("ok", "empty");
        }
      } catch (err) {
        console.error(err);
        const msg = err.response?.data?.detail || err.message || "에러 발생";
        resultEl.textContent = "에러 발생:\n" + msg;
        resultEl.classList.remove("markdown-content");
        setStatus("error", "error");
      }
    });

    document.getElementById("clear").addEventListener("click", function () {
      resultEl.textContent = "";
      resultEl.innerHTML = "";
      resultEl.classList.remove("markdown-content");
      setStatus("idle", "idle");
      wordEl.value = "";
      wordEl.focus();
    });

    // Enter 키로도 실행
    wordEl.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("under").click();
      }
    });

    // sessionId 입력창에서도 Enter 키 지원
    document.getElementById("sessionId").addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        document.getElementById("loadHistory").click();
      }
    });
  </script>
</body>
</html>